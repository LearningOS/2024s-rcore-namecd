# chapter 4 报告

## 功能简述

通过在`TaskControlBlock`块中添加有关系统调用以及系统时间的成员变量，完成`syscall_task_info`的系统调用实现。在这两个系统调用中，都是通过`translated_byte_buffer`获得可变的物理页帧，然后向其中写入即可。其他部分和`ch3`的练习一样

在`sys_mmap`和`sys_munmap`中，通过在`TaskControlBlock`中封装函数`alloc_memory`和`dealloc_memory`调用`MemorySet`中封装的函数`insert_framed_area`和`dealloc_area`实现。最后，在`TaskManger`中通过函数`current_task_alloc_memory` 和 `current_task_dealloc_memory`调用之前编写的`alloc_memory`和`dealloc_memory`函数完成实现。

值得注意的是，在`MemorySet`中加入了判断页面是否占用的函数`check_overlap`，以及检查空白页面的`check_blank`函数。在检查前注意页面对齐的问题，调用已经写好的函数`aligned`实现。

## 问答作业

1.    SV39页表项组成为：
   - [63 : 54] 是`Reserved` 字段，[ 53 : 10] 为`PPN`，即物理页号。[9 : 8] 为`RSW`字段，`Reserved for supervisor software`，最后 [7 : 0]为标志位。

   标志位的作用： 
   - `V(valid)`： 仅当位 V 为 1 时，页表项才是合法的 ；
   - `R(Read)/W(Write)/X(eXecute)`：分别控制索引到这个页表项的对应虚拟页面是否允许读/写/执行；
   - `U(User)`：控制索引到这个页表项的对应虚拟页面是否在 CPU 处于 U 特权级的情况下是否被允许访问；
   - `G(Global)`：  全局位，表示对应的页面是否是全局的。 
   - `A(Accessed)`：处理器记录自从页表项上的这一位被清零之后，页表项的对应虚拟页面是否被访问过；
   - `D(Dirty)`：处理器记录自从页表项上的这一位被清零之后，页表项的对应虚拟页面是否被修改过。

2. 缺页

   2.1. 哪些异常是缺页导致的？

      - 访问了一个虚拟地址，但是这个虚拟地址还没有映射到物理内存

   2.2 发生缺页时，重要的相关寄存器的值：

      - `Satp`： 包含地址空间描述符和根页表所在的物理页号

      - `pc`： 保存出错的指令

   2.3 好处

      - 降低了内存的硬件要求，节省内存空间
      -  加快程序的启动速度

   2.4 占用的内存

      - 10G / 4K  * （ 1 +  1 / 512 + 1 / 512 / 512） 
      - 大概在3M字节左右
  
   2.5 缺页处理
   
      - 在用户进程申请内存空间时，先分配基本的页表结构，例如分配一级页表和二级页表
      - 当用户第一次使用虚拟地址访问页面时，当作缺页，为这些页面分配物理页帧，并且更新页表项
      - 如果遇到缺页时，从磁盘加载进内存来，需要用到相关的页面置换算法
   
   2.6 swap
   
      - 可以通过将页表项的有效位V置0，表示页面无效。这样就可以被`find_pte_create`构建新的页表项
   
        
   
3. 双页表与单页表
   
   3.1  单页表更换页表
   
   - 通过`satp`寄存器，将对应地址空间的根页表项加载到`satp`，然后根据虚拟地址的`VPN`字段找到对应的地址。
   
   
   3.2   如何控制用户态无法访问内核页面？ 
   
   - 通过将页表的`PTEFlags`字段下的`U`字段置0，表示不允许用户态访问
   
   
   3.3  单页表有何优势？ 
   
   - 当应用程序对内核进行系统调用或接收到中断时，内核页表始终存在，因此可以避免大多数与上下文切换相关的开销（TLB 刷新、页表交换等） 
   
   3.4  双页表实现下，何时需要更换页表？假设你写一个单页表操作系统，你会选择何时更换页表（回答合理即可）？ 
   
   - 双页表下，任务切换和内核陷入时需要切换页表
   - 单页表下，只有任务切换才会需要切换页表
   
## 荣誉准则
1. 在完成本次实验的过程（含此前学习的过程）中，我曾分别与 以下各位 就（与本次实验相关的）以下方面做过交流，还在代码中对应的位置以注释形式记录了具体的交流对象及内容：

   > 无


2. 此外，我也参考了 以下资料 ，还在代码中对应的位置以注释形式记录了具体的参考来源及内容：

   >  [SV39 多级页表的硬件机制 - rCore-Tutorial-Book-v3 3.6.0-alpha.1 文档 (rcore-os.cn)](https://rcore-os.cn/rCore-Tutorial-Book-v3/chapter4/3sv39-implementation-1.html#id6) 
   >
   >  [第四章：地址空间 - rCore-Tutorial-Guide-2024S 文档 (learningos.cn)](https://learningos.cn/rCore-Tutorial-Guide-2024S/chapter4/index.html) 
   >
   >   [rCore 作业讲解与答疑 - 飞书云文档 (feishu.cn)](https://sjodqtoogh.feishu.cn/docx/ZoqBdmcmAoXi9yxZUkucMmxBnzg) 


3. 我独立完成了本次实验除以上方面之外的所有工作，包括代码与文档。 我清楚地知道，从以上方面获得的信息在一定程度上降低了实验难度，可能会影响起评分。

4. 我从未使用过他人的代码，不管是原封不动地复制，还是经过了某些等价转换。 我未曾也不会向他人（含此后各届同学）复制或公开我的实验代码，我有义务妥善保管好它们。 我提交至本实验的评测系统的代码，均无意于破坏或妨碍任何计算机系统的正常运转。 我清楚地知道，以上情况均为本课程纪律所禁止，若违反，对应的实验成绩将按“-100”分计。

   ​						